# ì„¤ê³„ ëª…ì„¸ì„œ

## 1. ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

### 1.1 ì „ì²´ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Presentation Layer                        â”‚
â”‚                 React SPA (Client App)                       â”‚
â”‚          React 18, TypeScript, Vite, TailwindCSS             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚ HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      API Layer                               â”‚
â”‚                 FastAPI REST API                             â”‚
â”‚         Python 3.11+, Uvicorn (Async Server)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚               â”‚               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Data Layer  â”‚ â”‚ AI Layer  â”‚ â”‚ Integration  â”‚
â”‚              â”‚ â”‚           â”‚ â”‚   Layer      â”‚
â”‚ Supabase     â”‚ â”‚ Rembg     â”‚ â”‚ Unsplash API â”‚
â”‚ PostgreSQL   â”‚ â”‚ OpenAI    â”‚ â”‚ Kakao SDK    â”‚
â”‚ Storage      â”‚ â”‚ (Docker)  â”‚ â”‚ Web Share    â”‚
â”‚ Redis        â”‚ â”‚           â”‚ â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ì£¼ìš” ì»´í¬ë„ŒíŠ¸

**Frontend (React)**
- ì˜¨ë³´ë”© í”Œë¡œìš° (5ë‹¨ê³„)
- ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ì²˜ë¦¬ UI
- SNS ê³µìœ  ëª¨ë‹¬
- ëŒ€ì‹œë³´ë“œ

**Backend (FastAPI)**
- ì´ë¯¸ì§€ ì²˜ë¦¬ API
- ê´‘ê³  ë¬¸êµ¬ ìƒì„± API
- ì‚¬ìš©ì ê´€ë¦¬ API
- í¬ë ˆë”§ ì‹œìŠ¤í…œ

**AI Services**
- Rembg (ë°°ê²½ ì œê±°)
- GPT-4 Vision (ì´ë¯¸ì§€ ë¶„ì„)
- GPT-4o-mini (ë¬¸êµ¬ ìƒì„±)

**BaaS (Supabase)**
- ì¸ì¦ (Auth)
- ë°ì´í„°ë² ì´ìŠ¤ (PostgreSQL)
- íŒŒì¼ ì €ì¥ì†Œ (Storage)
- ì‹¤ì‹œê°„ ì•Œë¦¼ (Realtime)

---

## 2. ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„

### 2.1 ERD (Entity Relationship Diagram)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    users     â”‚1â”€â”€â”€â”€â”€*â”‚  projects    â”‚1â”€â”€â”€â”€â”€*â”‚   images     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)      â”‚       â”‚ id (PK)      â”‚       â”‚ id (PK)      â”‚
â”‚ email        â”‚       â”‚ user_id (FK) â”‚       â”‚ project_id   â”‚
â”‚ credits      â”‚       â”‚ name         â”‚       â”‚ original_url â”‚
â”‚ created_at   â”‚       â”‚ created_at   â”‚       â”‚ processed_urlâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ style        â”‚
                                              â”‚ caption      â”‚
                                              â”‚ created_at   â”‚
                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ credit_transactionsâ”‚     â”‚ onboarding_progress  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)          â”‚       â”‚ user_id (PK, FK)     â”‚
â”‚ user_id (FK)     â”‚       â”‚ stage                â”‚
â”‚ amount           â”‚       â”‚ tutorial_step        â”‚
â”‚ reason           â”‚       â”‚ checklist            â”‚
â”‚ created_at       â”‚       â”‚ completed_at         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ prompt_violations  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)            â”‚
â”‚ user_id (FK)       â”‚
â”‚ violation_type     â”‚
â”‚ details            â”‚
â”‚ created_at         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 í…Œì´ë¸” ìƒì„¸ ì •ì˜

#### users
```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255),  -- ì†Œì…œ ë¡œê·¸ì¸ ì‹œ NULL
    provider VARCHAR(50),  -- 'email', 'google', 'kakao', 'naver'
    provider_id VARCHAR(255),
    credits INTEGER DEFAULT 10,  -- ê°€ì… ì‹œ 10 í¬ë ˆë”§
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_provider ON users(provider, provider_id);
```

#### projects
```sql
CREATE TABLE projects (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_projects_user ON projects(user_id);
```

#### images
```sql
CREATE TABLE images (
    id SERIAL PRIMARY KEY,
    project_id INTEGER NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    user_id INTEGER NOT NULL REFERENCES users(id),
    original_url TEXT NOT NULL,  -- Supabase Storage URL
    processed_url TEXT,
    style VARCHAR(50),  -- 'clean_white', 'luxury_marble', etc.
    caption TEXT,  -- AI ìƒì„± ê´‘ê³  ë¬¸êµ¬
    caption_metadata JSONB,  -- {type: 'recommended', length: 245, hashtags: [...]}
    quality_score FLOAT,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_images_project ON images(project_id);
CREATE INDEX idx_images_user ON images(user_id);
CREATE INDEX idx_images_created ON images(created_at DESC);
```

#### credit_transactions
```sql
CREATE TABLE credit_transactions (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id),
    amount INTEGER NOT NULL,  -- ì–‘ìˆ˜: ì¶©ì „, ìŒìˆ˜: ì°¨ê°
    reason VARCHAR(100) NOT NULL,  -- 'welcome_bonus', 'image_generation', etc.
    reference_id INTEGER,  -- ê´€ë ¨ ì´ë¯¸ì§€ ID ë“±
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_transactions_user ON credit_transactions(user_id);
```

#### onboarding_progress
```sql
CREATE TABLE onboarding_progress (
    user_id INTEGER PRIMARY KEY REFERENCES users(id),
    stage VARCHAR(20) NOT NULL,  -- 'landing', 'trial', 'signup', 'tutorial', 'dashboard'
    tutorial_step INTEGER,  -- 1, 2, 3
    checklist JSONB NOT NULL DEFAULT '{}',  -- {project_created: true, ...}
    completed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### trial_sessions (ë¹„íšŒì› ì²´í—˜)
```sql
CREATE TABLE trial_sessions (
    session_id VARCHAR(64) PRIMARY KEY,
    original_image_url TEXT NOT NULL,
    processed_image_url TEXT,
    style VARCHAR(50),
    caption TEXT,
    quality_score FLOAT,
    created_at TIMESTAMP DEFAULT NOW(),
    expires_at TIMESTAMP NOT NULL,  -- 24ì‹œê°„ í›„
    converted_to_user_id INTEGER REFERENCES users(id)
);

CREATE INDEX idx_trial_expires ON trial_sessions(expires_at);
```

#### prompt_violations
```sql
CREATE TABLE prompt_violations (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id),
    violation_type VARCHAR(50) NOT NULL,  -- 'banned_keyword', 'openai_moderation', etc.
    details JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_violations_user ON prompt_violations(user_id);
```

---

## 3. API ì„¤ê³„

### 3.1 ì¸ì¦ API

#### POST /api/v1/auth/signup
ê°€ì… ë° 10 í¬ë ˆë”§ ì§€ê¸‰

**Request:**
```json
{
  "email": "user@example.com",
  "password": "password123",
  "provider": "email"
}
```

**Response:**
```json
{
  "user": {
    "id": 1,
    "email": "user@example.com",
    "credits": 10
  },
  "token": "jwt_token_here"
}
```

#### POST /api/v1/auth/login
ë¡œê·¸ì¸

#### POST /api/v1/auth/social
ì†Œì…œ ë¡œê·¸ì¸ (Google, Kakao, Naver)

---

### 3.2 ì´ë¯¸ì§€ ì²˜ë¦¬ API

#### POST /api/v1/images/upload
ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ë°°ê²½ ì œê±°

**Request:**
```
Content-Type: multipart/form-data
- file: image file (max 10MB)
- project_id: integer
```

**Response:**
```json
{
  "image_id": 123,
  "original_url": "https://storage.supabase.co/...",
  "processed_url": "https://storage.supabase.co/...",
  "processing_time": 2.3
}
```

#### POST /api/v1/images/{image_id}/background
ë°°ê²½ í•©ì„±

**Request:**
```json
{
  "style": "luxury_marble",
  "seed": 42  // optional, ì¬í˜„ì„±
}
```

**Response:**
```json
{
  "image_id": 123,
  "final_url": "https://storage.supabase.co/...",
  "background": {
    "style": "luxury_marble",
    "photographer": "John Doe",
    "source": "unsplash"
  }
}
```

#### POST /api/v1/images/{image_id}/edit-prompt
AI í”„ë¡¬í”„íŠ¸ í¸ì§‘

**Request:**
```json
{
  "prompt": "ë°°ê²½ì„ ë” ë°ê²Œ, ìƒí’ˆì€ ì™¼ìª½ìœ¼ë¡œ",
  "credit_cost": 1
}
```

**Response:**
```json
{
  "image_id": 123,
  "edited_url": "https://storage.supabase.co/...",
  "credits_remaining": 9
}
```

---

### 3.3 ê´‘ê³  ë¬¸êµ¬ ìƒì„± API

#### POST /api/v1/images/{image_id}/generate-caption
ì´ë¯¸ì§€ ë¶„ì„ ë° ê´‘ê³  ë¬¸êµ¬ ìƒì„±

**Request:**
```json
{
  "tone": "friendly",  // 'friendly', 'passionate', 'luxury', 'direct'
  "platform": "instagram",
  "user_settings": {
    "length": "medium",
    "use_emoji": true,
    "avoid_flowery": false,
    "avoid_exaggeration": false,
    "custom_prompt": "í• ì¸ ì •ë³´ ê°•ì¡°"
  }
}
```

**Response:**
```json
{
  "image_analysis": {
    "category": "ìš´ë™í™”",
    "colors": ["white", "black"],
    "style": "minimalist",
    "mood": "energetic"
  },
  "variations": [
    {
      "type": "recommended",
      "caption": "ğŸŒŸ ìƒˆë¡œìš´ ë‚˜ë¥¼ ë§Œë‚˜ëŠ” ì‹œê°„!...",
      "length": 245,
      "hashtags": ["#ìš´ë™í™”", "#ìŠ¤ë‹ˆì»¤ì¦ˆ", "..."],
      "hashtag_count": 8
    },
    {
      "type": "question",
      "caption": "ë§¤ì¼ ì‹ ëŠ” ìš´ë™í™”, íŠ¹ë³„í•´ì ¸ì•¼ í•˜ì§€ ì•Šì„ê¹Œìš”?...",
      "length": 168,
      "hashtags": ["#ìš´ë™í™”", "..."],
      "hashtag_count": 6
    },
    {
      "type": "concise",
      "caption": "ìŠ¤íƒ€ì¼ê³¼ í¸ì•ˆí•¨, ë‘˜ ë‹¤ ì¡ì€ ëŸ¬ë‹í™” ğŸ‘Ÿ...",
      "length": 95,
      "hashtags": ["#ìš´ë™í™”", "..."],
      "hashtag_count": 4
    }
  ],
  "credits_remaining": 9.5
}
```

---

### 3.4 SNS ê³µìœ  API

#### GET /api/v1/share/prepare
ê³µìœ  ì¤€ë¹„ (ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ URL ìƒì„±)

**Response:**
```json
{
  "image_url": "https://...",
  "caption": "ì„ íƒí•œ ë¬¸êµ¬",
  "platforms": {
    "instagram": {
      "deep_link": "instagram://camera",
      "web_url": "https://www.instagram.com/"
    },
    "facebook": {
      "share_url": "https://www.facebook.com/sharer/..."
    }
  }
}
```

---

### 3.5 ì˜¨ë³´ë”© API

#### POST /api/v1/trial/generate
ì²´í—˜ ì´ë¯¸ì§€ ìƒì„± (ë¯¸ê°€ì…)

**Request:**
```
Content-Type: multipart/form-data
- file: image file
- style: string
- session_id: string
```

**Response:**
```json
{
  "preview_url": "https://... (ì›Œí„°ë§ˆí¬ í¬í•¨)",
  "session_id": "abc123",
  "expires_at": "2025-10-25T12:00:00Z"
}
```

#### POST /api/v1/trial/convert
ì²´í—˜ ì´ë¯¸ì§€ë¥¼ ì‹¤ì œ í”„ë¡œì íŠ¸ë¡œ ì „í™˜

**Request:**
```json
{
  "session_id": "abc123",
  "project_id": 1
}
```

**Response:**
```json
{
  "image_id": 123,
  "download_url": "https://... (ì›Œí„°ë§ˆí¬ ì—†ìŒ)"
}
```

#### POST /api/v1/onboarding/progress
ì˜¨ë³´ë”© ì§„í–‰ë¥  ì €ì¥

**Request:**
```json
{
  "stage": "tutorial",
  "tutorial_step": 2,
  "checklist": {
    "project_created": true,
    "image_generated": true,
    "caption_generated": false
  }
}
```

---

## 4. AI ëª¨ë¸ í†µí•© ì„¤ê³„

### 4.1 Rembg (ë°°ê²½ ì œê±°)

**Docker ì»¨í…Œì´ë„ˆ:**
```yaml
# docker-compose.yml
services:
  rembg:
    image: rembg:latest
    ports:
      - "5000:5000"
    volumes:
      - ./models:/models
    environment:
      - MODEL=u2net
```

**API í˜¸ì¶œ:**
```python
async def remove_background(image_path: str) -> str:
    """Rembg ì»¨í…Œì´ë„ˆë¡œ ë°°ê²½ ì œê±° ìš”ì²­"""
    with open(image_path, 'rb') as f:
        response = await httpx.post(
            'http://rembg:5000/remove',
            files={'file': f}
        )

    output_path = f"/tmp/nobg_{uuid.uuid4()}.png"
    with open(output_path, 'wb') as f:
        f.write(response.content)

    return output_path
```

### 4.2 OpenAI GPT-4 Vision (ì´ë¯¸ì§€ ë¶„ì„)

**í”„ë¡¬í”„íŠ¸ êµ¬ì¡°:**
```python
async def analyze_image(image_url: str) -> dict:
    """ì´ë¯¸ì§€ ë¶„ì„ (GPT-4 Vision)"""
    response = await openai.chat.completions.create(
        model="gpt-4-vision-preview",
        messages=[{
            "role": "user",
            "content": [
                {
                    "type": "text",
                    "text": """ì´ ìƒí’ˆ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”.

                    ë‹¤ìŒ ì •ë³´ë¥¼ JSONìœ¼ë¡œ ë°˜í™˜:
                    - category: ìƒí’ˆ ì¹´í…Œê³ ë¦¬
                    - colors: ì£¼ìš” ìƒ‰ìƒ 3ê°€ì§€
                    - style: ë°°ê²½ ìŠ¤íƒ€ì¼
                    - mood: ë¶„ìœ„ê¸°
                    - target_audience: íƒ€ê²Ÿ ê³ ê°"""
                },
                {
                    "type": "image_url",
                    "image_url": {"url": image_url}
                }
            ]
        }],
        max_tokens=300
    )

    return json.loads(response.choices[0].message.content)
```

### 4.3 OpenAI GPT-4o-mini (ë¬¸êµ¬ ìƒì„±)

**í”„ë¡¬í”„íŠ¸ êµ¬ì¡°:**
```python
async def generate_captions(
    image_analysis: dict,
    user_settings: dict,
    tone: str,
    platform: str
) -> list:
    """3ê°€ì§€ ìŠ¤íƒ€ì¼ì˜ ê´‘ê³  ë¬¸êµ¬ ìƒì„±"""

    prompt = f"""
ë‹¹ì‹ ì€ eì»¤ë¨¸ìŠ¤ ë§ˆì¼€íŒ… ì¹´í”¼ë¼ì´í„°ì…ë‹ˆë‹¤.
ë‹¤ìŒ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ **3ê°€ì§€ ìŠ¤íƒ€ì¼**ì˜ ê´‘ê³  ë¬¸êµ¬ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.

===== ì´ë¯¸ì§€ ë¶„ì„ =====
{json.dumps(image_analysis, ensure_ascii=False, indent=2)}

===== ì‚¬ìš©ì ì„¤ì • =====
ë¶„ìœ„ê¸°: {tone}
ê¸¸ì´: {user_settings['length']}
ì´ëª¨ì§€ ì‚¬ìš©: {user_settings['use_emoji']}

===== ìš”êµ¬ì‚¬í•­ =====
3ê°€ì§€ ìŠ¤íƒ€ì¼ë¡œ ê°ê° ìƒì„±:

1. ê°ì„±í˜• (ì¶”ì²œ):
   - ê°ì„±ì ì´ê³  ë”°ëœ»í•œ ëŠë‚Œ
   - 200-250ì
   - í•´ì‹œíƒœê·¸ 8-10ê°œ

2. ì§ˆë¬¸í˜•:
   - ì§ˆë¬¸ìœ¼ë¡œ ì‹œì‘
   - 150-200ì
   - í•´ì‹œíƒœê·¸ 5-7ê°œ

3. ê°„ê²°í˜•:
   - í•µì‹¬ë§Œ ê°„ê²°í•˜ê²Œ
   - 80-120ì
   - í•´ì‹œíƒœê·¸ 3-5ê°œ

===== ì¶œë ¥ í˜•ì‹ (JSON) =====
{{
  "variations": [
    {{
      "type": "recommended",
      "caption": "...",
      "length": 245,
      "hashtags": ["#ìš´ë™í™”", ...],
      "hashtag_count": 8
    }},
    ...
  ]
}}
"""

    response = await openai.chat.completions.create(
        model="gpt-4o-mini",
        messages=[
            {"role": "system", "content": "ë‹¹ì‹ ì€ eì»¤ë¨¸ìŠ¤ ë§ˆì¼€íŒ… ì¹´í”¼ë¼ì´í„°ì…ë‹ˆë‹¤."},
            {"role": "user", "content": prompt}
        ],
        temperature=0.8,
        max_tokens=1500
    )

    return json.loads(response.choices[0].message.content)["variations"]
```

---

## 5. ìºì‹± ì „ëµ

### 5.1 Redis ìºì‹±

**ì´ë¯¸ì§€ ë¶„ì„ ê²°ê³¼:**
```python
# ìºì‹œ í‚¤: image_analysis:{image_id}
# TTL: 1ì‹œê°„

cache_key = f"image_analysis:{image_id}"
cached = await redis.get(cache_key)

if cached:
    return json.loads(cached)

# ìºì‹œ ë¯¸ìŠ¤ ì‹œ ìƒˆë¡œ ë¶„ì„
analysis = await analyze_image(image_url)
await redis.setex(cache_key, 3600, json.dumps(analysis))
```

**ë°°ê²½ ì´ë¯¸ì§€:**
```python
# ìºì‹œ í‚¤: bg:{style}:{seed}
# TTL: 1ì‹œê°„

cache_key = f"bg:{style}:{seed or 'random'}"
cached = await redis.get(cache_key)

if cached:
    return json.loads(cached)
```

**Rate Limiting:**
```python
# ì¼ì¼ ì‚¬ìš©ëŸ‰
daily_key = f"prompt_daily:{user_id}:{today}"
daily_count = await redis.get(daily_key) or 0

if int(daily_count) >= 10:
    raise HTTPException(429, "ì¼ì¼ ì‚¬ìš© í•œë„ ì´ˆê³¼")

await redis.incr(daily_key)
await redis.expire(daily_key, 86400)  # 24ì‹œê°„
```

### 5.2 Supabase Storage ìºì‹±

**ì¸ê¸° ë°°ê²½ ì´ë¯¸ì§€ ì‚¬ì „ ì €ì¥:**
```python
# backgrounds/{style}/pool.json
# ê° ìŠ¤íƒ€ì¼ë³„ 100ê°œ ë°°ê²½ ì €ì¥

async def get_local_pool(style: str) -> list:
    """ë¡œì»¬ ì €ì¥ì†Œì—ì„œ ë°°ê²½ ëª©ë¡ ì¡°íšŒ"""
    path = f"backgrounds/{style}/pool.json"
    data = await supabase.storage.from_("images").download(path)
    return json.loads(data)
```

---

## 6. ë³´ì•ˆ ì„¤ê³„

### 6.1 ì¸ì¦ ë° ì¸ê°€

**Supabase RLS (Row Level Security):**
```sql
-- users í…Œì´ë¸”: ë³¸ì¸ ë°ì´í„°ë§Œ ì¡°íšŒ
CREATE POLICY users_select_own
ON users FOR SELECT
USING (auth.uid() = id);

-- projects í…Œì´ë¸”: ë³¸ì¸ í”„ë¡œì íŠ¸ë§Œ ì¡°íšŒ/ìˆ˜ì •
CREATE POLICY projects_select_own
ON projects FOR SELECT
USING (auth.uid() = user_id);

CREATE POLICY projects_insert_own
ON projects FOR INSERT
WITH CHECK (auth.uid() = user_id);
```

### 6.2 í”„ë¡¬í”„íŠ¸ ë‚¨ìš© ë°©ì§€

**ê¸ˆì§€ í‚¤ì›Œë“œ:**
```python
BANNED_KEYWORDS = [
    "nude", "naked", "nsfw", "porn", "sex",
    "blood", "gore", "violent", "weapon",
    "celebrity", "politician",
    "deepfake", "face swap",
    "drug", "cocaine"
]
```

**OpenAI Moderation API:**
```python
moderation = await openai.Moderation.create(input=prompt)
if moderation.results[0].flagged:
    raise HTTPException(400, "ë¶€ì ì ˆí•œ ë‚´ìš© ê°ì§€")
```

**ìœ„ë°˜ ë¡œê·¸ ë° ê³„ì • í”Œë˜ê·¸:**
```python
# 7ì¼ ë‚´ 3íšŒ ìœ„ë°˜ ì‹œ ê³„ì • í”Œë˜ê·¸
violation_count = await db.fetchval(
    """SELECT COUNT(*) FROM prompt_violations
       WHERE user_id = :user_id
       AND created_at > NOW() - INTERVAL '7 days'""",
    {"user_id": user_id}
)

if violation_count >= 3:
    await flag_user(user_id, "repeated_violations")
```

---

## 7. í”„ë¡ íŠ¸ì—”ë“œ ì„¤ê³„

### 7.1 ì»´í¬ë„ŒíŠ¸ êµ¬ì¡°

```
src/
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ LandingPage.tsx          # Stage 1
â”‚   â”œâ”€â”€ TrialPage.tsx             # Stage 2
â”‚   â”œâ”€â”€ OnboardingTutorial.tsx    # Stage 4
â”‚   â””â”€â”€ Dashboard.tsx             # Stage 5
â”‚
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ onboarding/
â”‚   â”‚   â”œâ”€â”€ BeforeAfterSlider.tsx
â”‚   â”‚   â”œâ”€â”€ SampleGallery.tsx
â”‚   â”‚   â”œâ”€â”€ TrialUpload.tsx
â”‚   â”‚   â”œâ”€â”€ ProcessingAnimation.tsx
â”‚   â”‚   â”œâ”€â”€ ResultPreview.tsx
â”‚   â”‚   â”œâ”€â”€ SignupModal.tsx
â”‚   â”‚   â”œâ”€â”€ TutorialStep.tsx
â”‚   â”‚   â”œâ”€â”€ ProgressBar.tsx
â”‚   â”‚   â”œâ”€â”€ Checklist.tsx
â”‚   â”‚   â””â”€â”€ StickySignupCTA.tsx
â”‚   â”‚
â”‚   â”œâ”€â”€ image/
â”‚   â”‚   â”œâ”€â”€ ImageEditor.tsx
â”‚   â”‚   â”œâ”€â”€ BackgroundSelector.tsx
â”‚   â”‚   â””â”€â”€ PromptEditor.tsx
â”‚   â”‚
â”‚   â”œâ”€â”€ caption/
â”‚   â”‚   â”œâ”€â”€ CaptionGenerator.tsx
â”‚   â”‚   â”œâ”€â”€ VariationSelector.tsx
â”‚   â”‚   â””â”€â”€ PlatformOptimizer.tsx
â”‚   â”‚
â”‚   â””â”€â”€ share/
â”‚       â”œâ”€â”€ SocialShareButton.tsx
â”‚       â”œâ”€â”€ PlatformSelector.tsx
â”‚       â””â”€â”€ AIAttributionBadge.tsx
â”‚
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useOnboardingProgress.ts
â”‚   â”œâ”€â”€ useTrialSession.ts
â”‚   â”œâ”€â”€ useImageGeneration.ts
â”‚   â””â”€â”€ useCaptionGeneration.ts
â”‚
â””â”€â”€ services/
    â”œâ”€â”€ api.ts
    â”œâ”€â”€ auth.ts
    â”œâ”€â”€ image.ts
    â”œâ”€â”€ caption.ts
    â””â”€â”€ share.ts
```

### 7.2 ìƒíƒœ ê´€ë¦¬ (Zustand)

```typescript
// stores/onboarding.ts
interface OnboardingState {
  user: {
    id: string | null;
    credits: number;
    isAuthenticated: boolean;
  };

  progress: {
    stage: 'landing' | 'trial' | 'signup' | 'tutorial' | 'dashboard';
    tutorialStep: 1 | 2 | 3 | null;
    completedSteps: string[];
  };

  trial: {
    imageId: string | null;
    originalUrl: string | null;
    processedUrl: string | null;
    watermarked: boolean;
  };

  checklist: {
    projectCreated: boolean;
    imageGenerated: boolean;
    captionGenerated: boolean;
    imageDownloaded: boolean;
    friendInvited: boolean;
  };
}
```

---

## 8. ë°°í¬ ì „ëµ

### 8.1 Phase 1: Vercel í†µí•© ë°°í¬ (MVP)

**êµ¬ì¡°:**
```
vercel-project/
â”œâ”€â”€ frontend/          # React SPA
â”‚   â””â”€â”€ dist/         # ë¹Œë“œ ê²°ê³¼ë¬¼
â””â”€â”€ api/              # FastAPI Serverless Functions
    â””â”€â”€ index.py      # ì§„ì…ì 
```

**ë°°í¬ êµ¬ì„±:**
- **Frontend**: Vercel Static Site
  - React ë¹Œë“œ ê²°ê³¼ë¬¼ (dist/)
  - CDN ìë™ ì ìš©
  - í™˜ê²½ ë³€ìˆ˜ ê´€ë¦¬ (.env)

- **Backend**: Vercel Serverless Functions
  - FastAPI â†’ Serverless Functions ë³€í™˜
  - `/api/*` ê²½ë¡œë¡œ ë¼ìš°íŒ…
  - Python 3.11 ëŸ°íƒ€ì„

- **ì œì•½ì‚¬í•­**:
  - Docker ì»¨í…Œì´ë„ˆ ì§ì ‘ ë°°í¬ ë¶ˆê°€
  - RembgëŠ” ì™¸ë¶€ ì„œë¹„ìŠ¤ í•„ìš” (Render, Fly.io ë¬´ë£Œ í‹°ì–´)
  - Serverless Functions ì œí•œ (10ì´ˆ timeout, 50MB)

**ì™¸ë¶€ ì„œë¹„ìŠ¤:**
- **Rembg**: Render.com ë¬´ë£Œ í‹°ì–´ (Docker ë°°í¬)
- **Supabase**: BaaS (PostgreSQL, Storage, Auth)
- **Redis**: Upstash (Serverless Redis)

### 8.2 Phase 2: Railway ì „í™˜ ê³ ë ¤ (í™•ì¥ ì‹œ)

**ì „í™˜ ì¡°ê±´:**
- Serverless Functions ì œì•½ìœ¼ë¡œ ì„±ëŠ¥ ì´ìŠˆ ë°œìƒ ì‹œ
- Docker ì»¨í…Œì´ë„ˆ í†µí•© ê´€ë¦¬ í•„ìš” ì‹œ
- ì›”ê°„ ìš”ì²­ëŸ‰ ì¦ê°€ë¡œ ë¹„ìš© íš¨ìœ¨ì„± ê°œì„  í•„ìš” ì‹œ

**Railway êµ¬ì„±:**
```yaml
services:
  frontend:
    type: static-site
    build: npm run build

  backend:
    type: web-service
    build: pip install -r requirements.txt
    start: uvicorn main:app --host 0.0.0.0

  rembg:
    type: docker
    image: rembg:latest

  redis:
    type: redis
```

**ì¥ì :**
- ëª¨ë“  ì„œë¹„ìŠ¤ ë‹¨ì¼ í”Œë«í¼ ê´€ë¦¬
- Docker ì»¨í…Œì´ë„ˆ ë„¤ì´í‹°ë¸Œ ì§€ì›
- PostgreSQL, Redis ë‚´ì¥
- Auto Scaling
- ì›” $5~10 ë¹„ìš© (ì˜ˆì¸¡ ê°€ëŠ¥)

### 8.3 CI/CD íŒŒì´í”„ë¼ì¸ (Vercel)

```yaml
# .github/workflows/deploy.yml
name: Deploy to Vercel

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Deploy to Vercel
        run: vercel --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
```

### 8.4 ë°°í¬ ì „ëµ ìš”ì•½

| í•­ëª© | Vercel (Phase 1) | Railway (Phase 2) |
|------|-----------------|-------------------|
| **Frontend** | Static Site | Static Site |
| **Backend** | Serverless Functions | Web Service |
| **Rembg** | ì™¸ë¶€ (Render) | Docker ë‚´ì¥ |
| **Database** | Supabase | Supabase or ë‚´ì¥ PostgreSQL |
| **Redis** | Upstash | ë‚´ì¥ Redis |
| **ë¹„ìš©** | ë¬´ë£Œ~$20/ì›” | $5~10/ì›” |
| **ì œì•½** | Timeout, Docker ë¶ˆê°€ | ì—†ìŒ |
| **ìš°ì„ ìˆœìœ„** | â­ MVP | í™•ì¥ ì‹œ ê³ ë ¤ |

---

## 9. ëª¨ë‹ˆí„°ë§ ë° ë¡œê¹…

### 9.1 ì—ëŸ¬ ì¶”ì 
- Sentry ì—°ë™
- ì‹¤ì‹œê°„ ì—ëŸ¬ ì•Œë¦¼
- ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ ë¶„ì„

### 9.2 ì‚¬ìš©ì ë¶„ì„
- Google Analytics 4
- Mixpanel
- í¼ë„ ë¶„ì„

### 9.3 ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
- Backend ì‘ë‹µ ì‹œê°„
- AI ì²˜ë¦¬ ì‹œê°„
- ìºì‹œ íˆíŠ¸ìœ¨

---

## 10. ê°œë°œ ìš°ì„ ìˆœìœ„

### Week 9-10 (MVP)
1. Backend í™˜ê²½ ì„¤ì •
2. Supabase ì—°ë™
3. Rembg Docker ì»¨í…Œì´ë„ˆ
4. ê¸°ë³¸ ì˜¨ë³´ë”© í”Œë¡œìš°
5. ì´ë¯¸ì§€ ìƒì„± API
6. ê´‘ê³  ë¬¸êµ¬ ìƒì„± API

### Week 11-12 (í•µì‹¬ ê¸°ëŠ¥)
1. SNS ê³µìœ  ê¸°ëŠ¥
2. í¬ë ˆë”§ ì‹œìŠ¤í…œ
3. í”„ë¡¬í”„íŠ¸ í¸ì§‘
4. ì‹ ê·œ ê¸°ëŠ¥ ì ê¸ˆ í•´ì œ
5. Sticky CTA

### Week 13 (í…ŒìŠ¤íŠ¸ ë° ë°°í¬)
1. í†µí•© í…ŒìŠ¤íŠ¸
2. ì„±ëŠ¥ ìµœì í™”
3. ë°°í¬
4. ë² íƒ€ í…ŒìŠ¤íŠ¸
