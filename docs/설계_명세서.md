# 설계 명세서

## 1. 시스템 아키텍처

### 1.1 전체 구조

```
┌─────────────────────────────────────────────────────────────┐
│                    Presentation Layer                        │
│                 React SPA (Client App)                       │
│          React 18, TypeScript, Vite, TailwindCSS             │
└───────────────────────┬─────────────────────────────────────┘
                        │ HTTPS
┌───────────────────────┴─────────────────────────────────────┐
│                      API Layer                               │
│                 FastAPI REST API                             │
│         Python 3.11+, Uvicorn (Async Server)                 │
└───────────────────────┬─────────────────────────────────────┘
                        │
        ┌───────────────┼───────────────┐
        │               │               │
┌───────▼──────┐ ┌─────▼─────┐ ┌──────▼───────┐
│  Data Layer  │ │ AI Layer  │ │ Integration  │
│              │ │           │ │   Layer      │
│ Supabase     │ │ Rembg     │ │ Unsplash API │
│ PostgreSQL   │ │ OpenAI    │ │ Kakao SDK    │
│ Storage      │ │ (Docker)  │ │ Web Share    │
│ Redis        │ │           │ │              │
└──────────────┘ └───────────┘ └──────────────┘
```

### 1.2 주요 컴포넌트

**Frontend (React)**
- 온보딩 플로우 (5단계)
- 이미지 업로드 및 처리 UI
- SNS 공유 모달
- 대시보드

**Backend (FastAPI)**
- 이미지 처리 API
- 광고 문구 생성 API
- 사용자 관리 API
- 크레딧 시스템

**AI Services**
- Rembg (배경 제거)
- GPT-4 Vision (이미지 분석)
- GPT-4o-mini (문구 생성)

**BaaS (Supabase)**
- 인증 (Auth)
- 데이터베이스 (PostgreSQL)
- 파일 저장소 (Storage)
- 실시간 알림 (Realtime)

---

## 2. 데이터베이스 설계

### 2.1 ERD (Entity Relationship Diagram)

```
┌──────────────┐       ┌──────────────┐       ┌──────────────┐
│    users     │1─────*│  projects    │1─────*│   images     │
├──────────────┤       ├──────────────┤       ├──────────────┤
│ id (PK)      │       │ id (PK)      │       │ id (PK)      │
│ email        │       │ user_id (FK) │       │ project_id   │
│ credits      │       │ name         │       │ original_url │
│ created_at   │       │ created_at   │       │ processed_url│
└──────────────┘       └──────────────┘       │ style        │
                                              │ caption      │
                                              │ created_at   │
                                              └──────────────┘

┌──────────────────┐       ┌──────────────────────┐
│ credit_transactions│     │ onboarding_progress  │
├──────────────────┤       ├──────────────────────┤
│ id (PK)          │       │ user_id (PK, FK)     │
│ user_id (FK)     │       │ stage                │
│ amount           │       │ tutorial_step        │
│ reason           │       │ checklist            │
│ created_at       │       │ completed_at         │
└──────────────────┘       └──────────────────────┘

┌────────────────────┐
│ prompt_violations  │
├────────────────────┤
│ id (PK)            │
│ user_id (FK)       │
│ violation_type     │
│ details            │
│ created_at         │
└────────────────────┘
```

### 2.2 테이블 상세 정의

#### users
```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255),  -- 소셜 로그인 시 NULL
    provider VARCHAR(50),  -- 'email', 'google', 'kakao', 'naver'
    provider_id VARCHAR(255),
    credits INTEGER DEFAULT 10,  -- 가입 시 10 크레딧
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_provider ON users(provider, provider_id);
```

#### projects
```sql
CREATE TABLE projects (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_projects_user ON projects(user_id);
```

#### images
```sql
CREATE TABLE images (
    id SERIAL PRIMARY KEY,
    project_id INTEGER NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    user_id INTEGER NOT NULL REFERENCES users(id),
    original_url TEXT NOT NULL,  -- Supabase Storage URL
    processed_url TEXT,
    style VARCHAR(50),  -- 'clean_white', 'luxury_marble', etc.
    caption TEXT,  -- AI 생성 광고 문구
    caption_metadata JSONB,  -- {type: 'recommended', length: 245, hashtags: [...]}
    quality_score FLOAT,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_images_project ON images(project_id);
CREATE INDEX idx_images_user ON images(user_id);
CREATE INDEX idx_images_created ON images(created_at DESC);
```

#### credit_transactions
```sql
CREATE TABLE credit_transactions (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id),
    amount INTEGER NOT NULL,  -- 양수: 충전, 음수: 차감
    reason VARCHAR(100) NOT NULL,  -- 'welcome_bonus', 'image_generation', etc.
    reference_id INTEGER,  -- 관련 이미지 ID 등
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_transactions_user ON credit_transactions(user_id);
```

#### onboarding_progress
```sql
CREATE TABLE onboarding_progress (
    user_id INTEGER PRIMARY KEY REFERENCES users(id),
    stage VARCHAR(20) NOT NULL,  -- 'landing', 'trial', 'signup', 'tutorial', 'dashboard'
    tutorial_step INTEGER,  -- 1, 2, 3
    checklist JSONB NOT NULL DEFAULT '{}',  -- {project_created: true, ...}
    completed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### trial_sessions (비회원 체험)
```sql
CREATE TABLE trial_sessions (
    session_id VARCHAR(64) PRIMARY KEY,
    original_image_url TEXT NOT NULL,
    processed_image_url TEXT,
    style VARCHAR(50),
    caption TEXT,
    quality_score FLOAT,
    created_at TIMESTAMP DEFAULT NOW(),
    expires_at TIMESTAMP NOT NULL,  -- 24시간 후
    converted_to_user_id INTEGER REFERENCES users(id)
);

CREATE INDEX idx_trial_expires ON trial_sessions(expires_at);
```

#### prompt_violations
```sql
CREATE TABLE prompt_violations (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id),
    violation_type VARCHAR(50) NOT NULL,  -- 'banned_keyword', 'openai_moderation', etc.
    details JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_violations_user ON prompt_violations(user_id);
```

---

## 3. API 설계

### 3.1 인증 API

#### POST /api/v1/auth/signup
가입 및 10 크레딧 지급

**Request:**
```json
{
  "email": "user@example.com",
  "password": "password123",
  "provider": "email"
}
```

**Response:**
```json
{
  "user": {
    "id": 1,
    "email": "user@example.com",
    "credits": 10
  },
  "token": "jwt_token_here"
}
```

#### POST /api/v1/auth/login
로그인

#### POST /api/v1/auth/social
소셜 로그인 (Google, Kakao, Naver)

---

### 3.2 이미지 처리 API

#### POST /api/v1/images/upload
이미지 업로드 및 배경 제거

**Request:**
```
Content-Type: multipart/form-data
- file: image file (max 10MB)
- project_id: integer
```

**Response:**
```json
{
  "image_id": 123,
  "original_url": "https://storage.supabase.co/...",
  "processed_url": "https://storage.supabase.co/...",
  "processing_time": 2.3
}
```

#### POST /api/v1/images/{image_id}/background
배경 합성

**Request:**
```json
{
  "style": "luxury_marble",
  "seed": 42  // optional, 재현성
}
```

**Response:**
```json
{
  "image_id": 123,
  "final_url": "https://storage.supabase.co/...",
  "background": {
    "style": "luxury_marble",
    "photographer": "John Doe",
    "source": "unsplash"
  }
}
```

#### POST /api/v1/images/{image_id}/edit-prompt
AI 프롬프트 편집

**Request:**
```json
{
  "prompt": "배경을 더 밝게, 상품은 왼쪽으로",
  "credit_cost": 1
}
```

**Response:**
```json
{
  "image_id": 123,
  "edited_url": "https://storage.supabase.co/...",
  "credits_remaining": 9
}
```

---

### 3.3 광고 문구 생성 API

#### POST /api/v1/images/{image_id}/generate-caption
이미지 분석 및 광고 문구 생성

**Request:**
```json
{
  "tone": "friendly",  // 'friendly', 'passionate', 'luxury', 'direct'
  "platform": "instagram",
  "user_settings": {
    "length": "medium",
    "use_emoji": true,
    "avoid_flowery": false,
    "avoid_exaggeration": false,
    "custom_prompt": "할인 정보 강조"
  }
}
```

**Response:**
```json
{
  "image_analysis": {
    "category": "운동화",
    "colors": ["white", "black"],
    "style": "minimalist",
    "mood": "energetic"
  },
  "variations": [
    {
      "type": "recommended",
      "caption": "🌟 새로운 나를 만나는 시간!...",
      "length": 245,
      "hashtags": ["#운동화", "#스니커즈", "..."],
      "hashtag_count": 8
    },
    {
      "type": "question",
      "caption": "매일 신는 운동화, 특별해져야 하지 않을까요?...",
      "length": 168,
      "hashtags": ["#운동화", "..."],
      "hashtag_count": 6
    },
    {
      "type": "concise",
      "caption": "스타일과 편안함, 둘 다 잡은 러닝화 👟...",
      "length": 95,
      "hashtags": ["#운동화", "..."],
      "hashtag_count": 4
    }
  ],
  "credits_remaining": 9.5
}
```

---

### 3.4 SNS 공유 API

#### GET /api/v1/share/prepare
공유 준비 (이미지 다운로드 URL 생성)

**Response:**
```json
{
  "image_url": "https://...",
  "caption": "선택한 문구",
  "platforms": {
    "instagram": {
      "deep_link": "instagram://camera",
      "web_url": "https://www.instagram.com/"
    },
    "facebook": {
      "share_url": "https://www.facebook.com/sharer/..."
    }
  }
}
```

---

### 3.5 온보딩 API

#### POST /api/v1/trial/generate
체험 이미지 생성 (미가입)

**Request:**
```
Content-Type: multipart/form-data
- file: image file
- style: string
- session_id: string
```

**Response:**
```json
{
  "preview_url": "https://... (워터마크 포함)",
  "session_id": "abc123",
  "expires_at": "2025-10-25T12:00:00Z"
}
```

#### POST /api/v1/trial/convert
체험 이미지를 실제 프로젝트로 전환

**Request:**
```json
{
  "session_id": "abc123",
  "project_id": 1
}
```

**Response:**
```json
{
  "image_id": 123,
  "download_url": "https://... (워터마크 없음)"
}
```

#### POST /api/v1/onboarding/progress
온보딩 진행률 저장

**Request:**
```json
{
  "stage": "tutorial",
  "tutorial_step": 2,
  "checklist": {
    "project_created": true,
    "image_generated": true,
    "caption_generated": false
  }
}
```

---

## 4. AI 모델 통합 설계

### 4.1 Rembg (배경 제거)

**Docker 컨테이너:**
```yaml
# docker-compose.yml
services:
  rembg:
    image: rembg:latest
    ports:
      - "5000:5000"
    volumes:
      - ./models:/models
    environment:
      - MODEL=u2net
```

**API 호출:**
```python
async def remove_background(image_path: str) -> str:
    """Rembg 컨테이너로 배경 제거 요청"""
    with open(image_path, 'rb') as f:
        response = await httpx.post(
            'http://rembg:5000/remove',
            files={'file': f}
        )

    output_path = f"/tmp/nobg_{uuid.uuid4()}.png"
    with open(output_path, 'wb') as f:
        f.write(response.content)

    return output_path
```

### 4.2 OpenAI GPT-4 Vision (이미지 분석)

**프롬프트 구조:**
```python
async def analyze_image(image_url: str) -> dict:
    """이미지 분석 (GPT-4 Vision)"""
    response = await openai.chat.completions.create(
        model="gpt-4-vision-preview",
        messages=[{
            "role": "user",
            "content": [
                {
                    "type": "text",
                    "text": """이 상품 이미지를 분석해주세요.

                    다음 정보를 JSON으로 반환:
                    - category: 상품 카테고리
                    - colors: 주요 색상 3가지
                    - style: 배경 스타일
                    - mood: 분위기
                    - target_audience: 타겟 고객"""
                },
                {
                    "type": "image_url",
                    "image_url": {"url": image_url}
                }
            ]
        }],
        max_tokens=300
    )

    return json.loads(response.choices[0].message.content)
```

### 4.3 OpenAI GPT-4o-mini (문구 생성)

**프롬프트 구조:**
```python
async def generate_captions(
    image_analysis: dict,
    user_settings: dict,
    tone: str,
    platform: str
) -> list:
    """3가지 스타일의 광고 문구 생성"""

    prompt = f"""
당신은 e커머스 마케팅 카피라이터입니다.
다음 정보를 바탕으로 **3가지 스타일**의 광고 문구를 생성해주세요.

===== 이미지 분석 =====
{json.dumps(image_analysis, ensure_ascii=False, indent=2)}

===== 사용자 설정 =====
분위기: {tone}
길이: {user_settings['length']}
이모지 사용: {user_settings['use_emoji']}

===== 요구사항 =====
3가지 스타일로 각각 생성:

1. 감성형 (추천):
   - 감성적이고 따뜻한 느낌
   - 200-250자
   - 해시태그 8-10개

2. 질문형:
   - 질문으로 시작
   - 150-200자
   - 해시태그 5-7개

3. 간결형:
   - 핵심만 간결하게
   - 80-120자
   - 해시태그 3-5개

===== 출력 형식 (JSON) =====
{{
  "variations": [
    {{
      "type": "recommended",
      "caption": "...",
      "length": 245,
      "hashtags": ["#운동화", ...],
      "hashtag_count": 8
    }},
    ...
  ]
}}
"""

    response = await openai.chat.completions.create(
        model="gpt-4o-mini",
        messages=[
            {"role": "system", "content": "당신은 e커머스 마케팅 카피라이터입니다."},
            {"role": "user", "content": prompt}
        ],
        temperature=0.8,
        max_tokens=1500
    )

    return json.loads(response.choices[0].message.content)["variations"]
```

---

## 5. 캐싱 전략

### 5.1 Redis 캐싱

**이미지 분석 결과:**
```python
# 캐시 키: image_analysis:{image_id}
# TTL: 1시간

cache_key = f"image_analysis:{image_id}"
cached = await redis.get(cache_key)

if cached:
    return json.loads(cached)

# 캐시 미스 시 새로 분석
analysis = await analyze_image(image_url)
await redis.setex(cache_key, 3600, json.dumps(analysis))
```

**배경 이미지:**
```python
# 캐시 키: bg:{style}:{seed}
# TTL: 1시간

cache_key = f"bg:{style}:{seed or 'random'}"
cached = await redis.get(cache_key)

if cached:
    return json.loads(cached)
```

**Rate Limiting:**
```python
# 일일 사용량
daily_key = f"prompt_daily:{user_id}:{today}"
daily_count = await redis.get(daily_key) or 0

if int(daily_count) >= 10:
    raise HTTPException(429, "일일 사용 한도 초과")

await redis.incr(daily_key)
await redis.expire(daily_key, 86400)  # 24시간
```

### 5.2 Supabase Storage 캐싱

**인기 배경 이미지 사전 저장:**
```python
# backgrounds/{style}/pool.json
# 각 스타일별 100개 배경 저장

async def get_local_pool(style: str) -> list:
    """로컬 저장소에서 배경 목록 조회"""
    path = f"backgrounds/{style}/pool.json"
    data = await supabase.storage.from_("images").download(path)
    return json.loads(data)
```

---

## 6. 보안 설계

### 6.1 인증 및 인가

**Supabase RLS (Row Level Security):**
```sql
-- users 테이블: 본인 데이터만 조회
CREATE POLICY users_select_own
ON users FOR SELECT
USING (auth.uid() = id);

-- projects 테이블: 본인 프로젝트만 조회/수정
CREATE POLICY projects_select_own
ON projects FOR SELECT
USING (auth.uid() = user_id);

CREATE POLICY projects_insert_own
ON projects FOR INSERT
WITH CHECK (auth.uid() = user_id);
```

### 6.2 프롬프트 남용 방지

**금지 키워드:**
```python
BANNED_KEYWORDS = [
    "nude", "naked", "nsfw", "porn", "sex",
    "blood", "gore", "violent", "weapon",
    "celebrity", "politician",
    "deepfake", "face swap",
    "drug", "cocaine"
]
```

**OpenAI Moderation API:**
```python
moderation = await openai.Moderation.create(input=prompt)
if moderation.results[0].flagged:
    raise HTTPException(400, "부적절한 내용 감지")
```

**위반 로그 및 계정 플래그:**
```python
# 7일 내 3회 위반 시 계정 플래그
violation_count = await db.fetchval(
    """SELECT COUNT(*) FROM prompt_violations
       WHERE user_id = :user_id
       AND created_at > NOW() - INTERVAL '7 days'""",
    {"user_id": user_id}
)

if violation_count >= 3:
    await flag_user(user_id, "repeated_violations")
```

---

## 7. 프론트엔드 설계

### 7.1 컴포넌트 구조

```
src/
├── pages/
│   ├── LandingPage.tsx          # Stage 1
│   ├── TrialPage.tsx             # Stage 2
│   ├── OnboardingTutorial.tsx    # Stage 4
│   └── Dashboard.tsx             # Stage 5
│
├── components/
│   ├── onboarding/
│   │   ├── BeforeAfterSlider.tsx
│   │   ├── SampleGallery.tsx
│   │   ├── TrialUpload.tsx
│   │   ├── ProcessingAnimation.tsx
│   │   ├── ResultPreview.tsx
│   │   ├── SignupModal.tsx
│   │   ├── TutorialStep.tsx
│   │   ├── ProgressBar.tsx
│   │   ├── Checklist.tsx
│   │   └── StickySignupCTA.tsx
│   │
│   ├── image/
│   │   ├── ImageEditor.tsx
│   │   ├── BackgroundSelector.tsx
│   │   └── PromptEditor.tsx
│   │
│   ├── caption/
│   │   ├── CaptionGenerator.tsx
│   │   ├── VariationSelector.tsx
│   │   └── PlatformOptimizer.tsx
│   │
│   └── share/
│       ├── SocialShareButton.tsx
│       ├── PlatformSelector.tsx
│       └── AIAttributionBadge.tsx
│
├── hooks/
│   ├── useOnboardingProgress.ts
│   ├── useTrialSession.ts
│   ├── useImageGeneration.ts
│   └── useCaptionGeneration.ts
│
└── services/
    ├── api.ts
    ├── auth.ts
    ├── image.ts
    ├── caption.ts
    └── share.ts
```

### 7.2 상태 관리 (Zustand)

```typescript
// stores/onboarding.ts
interface OnboardingState {
  user: {
    id: string | null;
    credits: number;
    isAuthenticated: boolean;
  };

  progress: {
    stage: 'landing' | 'trial' | 'signup' | 'tutorial' | 'dashboard';
    tutorialStep: 1 | 2 | 3 | null;
    completedSteps: string[];
  };

  trial: {
    imageId: string | null;
    originalUrl: string | null;
    processedUrl: string | null;
    watermarked: boolean;
  };

  checklist: {
    projectCreated: boolean;
    imageGenerated: boolean;
    captionGenerated: boolean;
    imageDownloaded: boolean;
    friendInvited: boolean;
  };
}
```

---

## 8. 배포 전략

### 8.1 Phase 1: Vercel 통합 배포 (MVP)

**구조:**
```
vercel-project/
├── frontend/          # React SPA
│   └── dist/         # 빌드 결과물
└── api/              # FastAPI Serverless Functions
    └── index.py      # 진입점
```

**배포 구성:**
- **Frontend**: Vercel Static Site
  - React 빌드 결과물 (dist/)
  - CDN 자동 적용
  - 환경 변수 관리 (.env)

- **Backend**: Vercel Serverless Functions
  - FastAPI → Serverless Functions 변환
  - `/api/*` 경로로 라우팅
  - Python 3.11 런타임

- **제약사항**:
  - Docker 컨테이너 직접 배포 불가
  - Rembg는 외부 서비스 필요 (Render, Fly.io 무료 티어)
  - Serverless Functions 제한 (10초 timeout, 50MB)

**외부 서비스:**
- **Rembg**: Render.com 무료 티어 (Docker 배포)
- **Supabase**: BaaS (PostgreSQL, Storage, Auth)
- **Redis**: Upstash (Serverless Redis)

### 8.2 Phase 2: Railway 전환 고려 (확장 시)

**전환 조건:**
- Serverless Functions 제약으로 성능 이슈 발생 시
- Docker 컨테이너 통합 관리 필요 시
- 월간 요청량 증가로 비용 효율성 개선 필요 시

**Railway 구성:**
```yaml
services:
  frontend:
    type: static-site
    build: npm run build

  backend:
    type: web-service
    build: pip install -r requirements.txt
    start: uvicorn main:app --host 0.0.0.0

  rembg:
    type: docker
    image: rembg:latest

  redis:
    type: redis
```

**장점:**
- 모든 서비스 단일 플랫폼 관리
- Docker 컨테이너 네이티브 지원
- PostgreSQL, Redis 내장
- Auto Scaling
- 월 $5~10 비용 (예측 가능)

### 8.3 CI/CD 파이프라인 (Vercel)

```yaml
# .github/workflows/deploy.yml
name: Deploy to Vercel

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Deploy to Vercel
        run: vercel --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
```

### 8.4 배포 전략 요약

| 항목 | Vercel (Phase 1) | Railway (Phase 2) |
|------|-----------------|-------------------|
| **Frontend** | Static Site | Static Site |
| **Backend** | Serverless Functions | Web Service |
| **Rembg** | 외부 (Render) | Docker 내장 |
| **Database** | Supabase | Supabase or 내장 PostgreSQL |
| **Redis** | Upstash | 내장 Redis |
| **비용** | 무료~$20/월 | $5~10/월 |
| **제약** | Timeout, Docker 불가 | 없음 |
| **우선순위** | ⭐ MVP | 확장 시 고려 |

---

## 9. 모니터링 및 로깅

### 9.1 에러 추적
- Sentry 연동
- 실시간 에러 알림
- 스택 트레이스 분석

### 9.2 사용자 분석
- Google Analytics 4
- Mixpanel
- 퍼널 분석

### 9.3 성능 모니터링
- Backend 응답 시간
- AI 처리 시간
- 캐시 히트율

---

## 10. 개발 우선순위

### Week 9-10 (MVP)
1. Backend 환경 설정
2. Supabase 연동
3. Rembg Docker 컨테이너
4. 기본 온보딩 플로우
5. 이미지 생성 API
6. 광고 문구 생성 API

### Week 11-12 (핵심 기능)
1. SNS 공유 기능
2. 크레딧 시스템
3. 프롬프트 편집
4. 신규 기능 잠금 해제
5. Sticky CTA

### Week 13 (테스트 및 배포)
1. 통합 테스트
2. 성능 최적화
3. 배포
4. 베타 테스트
